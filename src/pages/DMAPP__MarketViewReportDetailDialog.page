<apex:page standardController="DMAPP__DM_Market_View_Report__c" extensions="DMAPP.MarketViewStandardController" >

<script>

	/*
	 * Copyright Â© {! JSENCODE($Setup.DMAPP__Company_Information__c.DMAPP__Company_Name__c)}. All rights reserved.
	 *
	 */

    var ttg = ttg || {};
    ttg.am = ttg.am || {};

    ttg.am.marketviewdetaildialog = function(spec) {

        var api = spec.api,
            reportid = spec.reportid,
            config = spec.config,
            userid = spec.userid,
            user = spec.user,
            view = spec.view,
            opps = null;

        var working = false;

        var ajaxSpinnerCnt = 0;

        var currencys = null;
        var corporateCurrency = null;

        var getCurrencys = function() {
	   		apilayer.searchCurrencys(function(data) {
	        	if(data) {
	                currencys = jQuery.makeArray(data.currencys.currency);

					jQuery.each(currencys, function(idx, c) {
						if ( c.iscorporate ) {
							corporateCurrency = c.name;
						}
					});
				}
				else {
					currencys = [];
				}

			}, function() {}, function() {});
        };

        var openIntersectionPopup = function(plan, solution, opptype) {
            view = opptype;

            //if(!plan && !solution) {
            //    return;//we need at least one specified ...
            //}

            if(working) {
                return;//ensure only one dialog can appear
            }

      			if ( config.multiCurrency && !currencys ) {
      	            getCurrencys();
      			}

            var tabs, potentialDiv, currentDiv, wonDiv,
                dateFormat =  '{!JSENCODE(dateFormat)}' || 'yy-mm-dd',
                jsonDateFormat = 'yy-mm-dd',

            dateFormat = dateFormat.replace(/yyyy/gi, 'yy');
            working = true;

            function stopWorking() {
                working = false;
            }

            function createTabs() {
                var tabs = jQuery('<div/>', {id: 'intersectionDialog'}).append(jQuery('<ul/>')
                                .append(jQuery('<li/>').append(jQuery('<a/>', {href: '#potentialDiv'}).text('{!JSENCODE($Label.AM_POTENTIAL)}')))
                                .append(jQuery('<li/>').append(jQuery('<a/>', {href: '#currentDiv'}).text('{!JSENCODE($Label.AM_CURRENT)}')))
                                .append(jQuery('<li/>').append(jQuery('<a/>', {href: '#closedWonDiv'}).text('{!JSENCODE($Label.AM_WON)}')))
                );

                jQuery('#intersectionDialog').parent().addClass('intersectionDialogParent');

                potentialDiv = createPotentialDiv();
                currentDiv = createCurrentDiv('current');
                wonDiv = createCurrentDiv('won');

                tabs.append(jQuery('<div/>', {id: 'potentialDiv'}).append(potentialDiv.getContainer()))
                    .append(jQuery('<div/>', {id: 'currentDiv'}).append(currentDiv.getContainer()))
                    .append(jQuery('<div/>', {id: 'closedWonDiv'}).append(wonDiv.getContainer()));

                var selectedTab = 0;
                switch(view) {
                    case 'current':
                        selectedTab = 1;
                        break;
                    case 'won':
                        selectedTab = 2;
                        break;
                    default:
                    break;
                }

                tabs.tabs({selected: selectedTab, active: selectedTab});

                return tabs;
            }

            function createPotentialDiv() {

                var potentialDiv = jQuery('<div/>').addClass('tabMainContainer'),
                    errorMsg = jQuery('<span/>').addClass('potentialOppErrorMsg'),
                    potentialTable = jQuery('<table/>', { id: 'potentialTable'}).addClass('opportunities'),
                    metadata;

                // IE7 and IE8 hack
                if(navigator.appVersion.indexOf('MSIE 8.') != -1) {
                    potentialTable.css('table-layout','fixed');
                }

                potentialTable.append(jQuery('<tr/>').append(jQuery('<th/>').text('{!JSENCODE($Label.COMMON_OWNER)}'))
                                                     .append(jQuery('<th/>').text('{!JSENCODE($Label.COL_OPP_NAME)}'))
                                                     .append(jQuery('<th/>').text('{!JSENCODE($Label.AM_PLAN)}'))
                                                     //.append(jQuery('<th/>').text('Solution'))
                                                     .append(jQuery('<th/>').text('{!JSENCODE($Label.COL_AMOUNT)}').addClass('col_amount'))
                                                     .append(null)
                                                     .append(null)
                                                     .append(null)
                                     );

                potentialDiv.append(potentialTable);
                potentialDiv.on('ttg_disable_all', function() {
                    jQuery(this).find('button').attr('disabled', 'disabled');
                });
                potentialDiv.on('ttg_enable_all', function() {
                    jQuery(this).find('button').removeAttr('disabled');
                });

                if(opps && opps.potential) {
                    for(var i = 0; i < opps.potential.length; i++) {
                        var opportunityRow = jQuery('<tr/>');
                        potentialTable.append(createOpportunityRow(opps.potential[i]));
                    }
                }

                function createOpportunityRow(opp) {

		                var amountFormattedHtml = jQuery('<td/>').text((opp.amountFormatted || '')).addClass('col_amount');
		                if ( config.multiCurrency ) {
		                	amountFormattedHtml = ttg.formatMultiCurrencyAmount(opp.baseAmountFormatted, opp.amountFormatted, opp.isocode, corporateCurrency);
		                }

                        var opportunityRow = jQuery('<tr/>');
                        opportunityRow.append(jQuery('<td/>').text(opp.owner))
                                      .append(jQuery('<td/>').text(opp.name).addClass('col_opp_name'))
                                      .append(jQuery('<td/>').text(opp.planname))
                                      //.append(jQuery('<td/>').text(opp.solutionname))
                                      .append(amountFormattedHtml)
                                      .append(null)
                                      .append(null)
                                      .append(null)
                        return opportunityRow;
                }

                return {
                        getContainer : function() { return potentialDiv; }
                       };
            }

            function createCurrentDiv(oppType) {

                var currentDiv = jQuery('<div/>').addClass('tabMainContainer');

                var currentTable = jQuery('<table/>', {id: oppType + 'Table'}).addClass('opportunities');
                currentTable.append(jQuery('<tr/>').append(jQuery('<th/>').text('{!JSENCODE($Label.COMMON_OWNER)}'))
                                                   .append(jQuery('<th/>').text('{!JSENCODE($Label.COL_OPP_NAME)}'))
                                                   .append(jQuery('<th/>').text('{!JSENCODE($Label.AM_PLAN)}'))
                                                   //.append(jQuery('<th/>').text('Solution'))
                                                   .append(jQuery('<th/>').text('{!JSENCODE($Label.AM_MARKET_VIEW_SOLUTION_TOTAL)}').addClass('col_amount'))
                                                   .append(jQuery('<th/>').text('{!JSENCODE($Label.COMMON_TOTAL_LBL)}').addClass('col_amount'))
                                                   .append(jQuery('<th/>').text('{!JSENCODE($Label.COL_STAGE)}'))
                                                   .append(jQuery('<th/>').text('{!JSENCODE($Label.COMMON_CLOSE)}'))
                                                   .append(jQuery('<th/>').text('%'))
                                                   .append(null)
                                     );

                currentDiv.append(currentTable);

                if(opps && opps[oppType]) {
                    for(var i = 0; i < opps[oppType].length; i++) {
                        var opportunityRow = jQuery('<tr/>');
                        currentTable.append(createOpportunityRow(opps[oppType][i]));
                    }
                }

                 function createOpportunityRow(opp) {
                        var linkid = opp.lineItemId ? opp.lineItemId : opp.opportunityId;

		                var amountFormattedHtml = jQuery('<td/>').text((opp.amountFormatted || '')).addClass('col_amount');
		                var solutionAmountFormattedHtml = jQuery('<td/>').text((opp.solutionAmountFormatted || '')).addClass('col_amount');

		                if ( config.multiCurrency ) {

		                	amountFormattedHtml = ttg.formatMultiCurrencyAmount(opp.baseAmountFormatted, opp.amountFormatted, opp.isocode, corporateCurrency);
		                	solutionAmountFormattedHtml = ttg.formatMultiCurrencyAmount(opp.baseSolutionAmountFormatted, opp.solutionAmountFormatted, opp.isocode, corporateCurrency);
		                }


                        var opportunityRow = jQuery('<tr/>');
                          opportunityRow.append(jQuery('<td/>').text(opp.owner))
                                      .append(jQuery('<td/>').append(
                                      	jQuery('<a/>', {
                                      		href: '/' + linkid
                                      	}).text(opp.name)).addClass('col_opp_name'))
                                      .append(jQuery('<td/>').text(opp.planname))
                                      //.append(jQuery('<td/>').text(opp.solutionname))
                                      .append(solutionAmountFormattedHtml)
                                      .append(amountFormattedHtml)
                                      .append(jQuery('<td/>').text((opp.stageName || '')))
                                      .append(jQuery('<td/>').text(jQuery.datepicker.formatDate(dateFormat,new Date(opp.closeDate))))
                                      .append(jQuery('<td/>').text(opp.probability))
                                      .append(null);
                        return opportunityRow;
                }

                return {
                    getContainer : function() { return currentDiv; }
                };
            }

            function showAjaxSpinner(show) {
                var spinner = jQuery('#dialogSpinner').css({ position: 'absolute', 'z-index': 10000});
                if (show) {
                    ajaxSpinnerCnt++;
                    if (ajaxSpinnerCnt == 1) {
                        spinner.append(jQuery('<img>').attr('id', 'tas_ajax_spinner').addClass('spinner').attr('src', '{!JSENCODE(URLFOR($Resource.ttgomjs, '/ttg/graph/images/loader.gif'))}'));
                        spinner.css("top", ( jQuery(window).height() - jQuery('#dialogSpinner').height() ) / 2+jQuery(window).scrollTop() + "px");
                        spinner.css("left", ( jQuery(window).width() - jQuery('#dialogSpinner').width() ) / 2+jQuery(window).scrollLeft() + "px");
                    }
                }
                else {
                    ajaxSpinnerCnt--;
                    if (ajaxSpinnerCnt <= 0) {
                        jQuery('#dialogSpinner').html('');
                        ajaxSpinnerCnt = 0;
                    }
                }
            }

            function openActualDialog() {
                var dialog = jQuery('<div/>', {id: 'intersectionDialog'});
				        var hiddenOppsMsg = jQuery('<span/>', {id: 'hiddenOppsErrorMsg'}).text('{!JSENCODE($Label.AM_MARKET_HIDDEN_OPPS_LBL)}');
                dialog.dialog({
                    buttons     :
                    [
                        {
                            ttgid: 'market_view_intersection_close',
                            text: '{!JSENCODE($Label.COMMON_CLOSE)}', click: function() { jQuery(this).dialog('close'); }
                        }
                    ],
                    modal: true,
                    resizable: false,
                    width: 720,
                    height: 'auto',
                    autoOpen: false,
                    title: jQuery('<pre/>')
                               .text(
                                  ttg.formatStringMap('{!JSENCODE($Label.AM_MARKET_VIEW_INTERSECTION_TITLE)}', {
                                    plan: (plan && plan.name ? plan.name : '{!JSENCODE($Label.COMMON_ALL)}'), 
                                    solution: (solution && solution.name ? solution.name : '{!JSENCODE($Label.COMMON_ALL)}')
                                  })
                                )
                               .html() ,
                    close: function() {
                        dialog.remove();
                    },
                    open: function() {
                       stopWorking();
                       jQuery('span.ui-dialog-title').focus();
                    },
                    closeText: '{!JSENCODE($Label.COMMON_CLOSE)}'
                });
                dialog.prepend(hiddenOppsMsg);

                //expect as opps = { current: [], won: [], potential: [] }
                showAjaxSpinner(true);
                apilayer.getMarketViewDetail(
                    reportid,
                    solution ? solution.id : null,
                    plan ? plan.id : null,
                    function(data)
                    {
                        opps = data;
                        tabs = createTabs();
		                dialog.append(tabs);
		                dialog.dialog('open');
                        if(data.hiddenOpps) {
                        	jQuery('#hiddenOppsErrorMsg').show().css('display', 'inline-block');
                        }
                        else {
                        	jQuery('#hiddenOppsErrorMsg').hide();
                        }
                    },
                    function() {},
                    function() { showAjaxSpinner(false); }
                );
            }

            openActualDialog();
        };

        return { openIntersectionPopup: openIntersectionPopup };
    }

</script>

</apex:page>