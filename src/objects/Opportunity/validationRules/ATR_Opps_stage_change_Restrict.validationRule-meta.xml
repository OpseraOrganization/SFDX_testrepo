<?xml version="1.0" encoding="UTF-8"?>
<ValidationRule xmlns="http://soap.sforce.com/2006/04/metadata">
    <fullName>ATR_Opps_stage_change_Restrict</fullName>
    <active>true</active>
    <description>For ATR opportunities user should be allowed to change Stage value only after associating an opportunity product.</description>
    <errorConditionFormula>AND(NOT(ISNEW()), ISCHANGED(StageName),
not CONTAINS( $Profile.Name, &quot;API&quot; ),
not CONTAINS( $Profile.Name, &quot;System Admin&quot; ),
(OR(RecordType.Name ==&apos;AM Catalog&apos;,RecordType.Name ==&apos;AM Complex&apos;,
RecordType.Name ==&apos;AM Standard&apos;,RecordType.Name ==&apos;ATR Channel&apos;,RecordType.Name ==&apos;OE Standard&apos;,RecordType.Name ==&apos;OE Complex&apos;)),
(OR(Total_Product_Count__c==0.0,
Has_Schedule__c==0.0)),
Win_Only_Opportunity__c = false,
NOT(ISPICKVAL(StageName, &apos;Prospecting&apos;)),
NOT(ISPICKVAL(StageName, &apos;Cultivate&apos;)),
NOT(ISPICKVAL(StageName, &apos;Closed Lost&apos;)),
NOT(ISPICKVAL(StageName, &apos;Closed Cancelled&apos;))
)</errorConditionFormula>
    <errorMessage>Please add an Opportunity Product and Schedule prior to proceeding past the Prospecting Stage.</errorMessage>
</ValidationRule>
